<!DOCTYPE html>
<head>
    <link rel="icon" href="favicon.ico" />
    <title>SNAP Map Texas - Interactive Map Visualization by Kiron Ang</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #a47764;
            color: #7e212a;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            margin-top: 20px;
            height: 80vh;
        }
        
        .map-container {
            flex: 3;
            position: relative;
            height: 100%;
        }
        
        .sidebar {
            flex: 1;
            background-color: #ffb082;
            padding: 15px;
            border-radius: 8px;
            margin-left: 20px;
            height: calc(100% - 30px);
            overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .sidebar h2 {
            color: #7e212a;
            margin-top: 0;
            border-bottom: 2px solid #7e212a;
            padding-bottom: 8px;
        }
        
        .store-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #d3b8ae;
        }
        
        .store-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .store-address, .store-type {
            margin-top: 5px;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: #ffb082;
            border: 1px solid #7e212a;
            color: #7e212a;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: #ffa06c;
        }
        
        .title-container {
            background-color: #ffb082;
            padding: 8px 20px;
            border-radius: 30px;
            display: inline-block;
            margin: 20px 0 10px 0;
        }
        
        h1 {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="title-container">
        <h1>SNAP Map Texas</h1>
    </div>
    <div class="container">
        <div class="map-container" id="map-container"></div>
        <div class="sidebar">
            <h2>Ten Closest SNAP Retailers</h2>
            <div id="closest-stores">
                <p>Click on the map to find the closest SNAP retailers.</p>
            </div>
        </div>
    </div>
    
    <script type="module">
        import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
        
        const mapContainer = document.getElementById("map-container");
        const width = mapContainer.clientWidth;
        const height = mapContainer.clientHeight;
        const margin = height * 0.02;
        
        // Create map SVG
        const svg = d3.create("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .style("background-color", "#ffb082")
            .style("border-radius", "8px");
            
        // Add the SVG to the container
        mapContainer.appendChild(svg.node());
        
        // Add zoom controls
        const zoomControls = document.createElement("div");
        zoomControls.className = "zoom-controls";
        
        const zoomInBtn = document.createElement("button");
        zoomInBtn.className = "zoom-btn";
        zoomInBtn.innerHTML = "+";
        
        const zoomOutBtn = document.createElement("button");
        zoomOutBtn.className = "zoom-btn";
        zoomOutBtn.innerHTML = "-";
        
        const resetBtn = document.createElement("button");
        resetBtn.className = "zoom-btn";
        resetBtn.innerHTML = "â†º";
        
        zoomControls.appendChild(zoomInBtn);
        zoomControls.appendChild(zoomOutBtn);
        zoomControls.appendChild(resetBtn);
        mapContainer.appendChild(zoomControls);
        
        // Load data
        d3.csv("data.csv", d3.autoType).then(data => {
            // Keep track of current transform
            let currentTransform = d3.zoomIdentity;
            let lastClickCoordinates = null;
            
            // Create scales
            const x = d3.scaleLinear()
                .domain(d3.extent(data, d => d.X)).nice()
                .range([margin, width - margin]);
                
            const y = d3.scaleLinear()
                .domain(d3.extent(data, d => d.Y)).nice()
                .range([height - margin, margin]);
            
            // Create a group for all map elements
            const g = svg.append("g");
            
            // Set constant sizes
            const BASE_RADIUS = 2; // Start small
            const HIGHLIGHT_BASE_RADIUS = 3;
            const MAX_RADIUS = 12; // Maximum radius when zoomed in
            
            // Draw points
            const circles = g.selectAll("circle")
                .data(data)
                .join("circle")
                .attr("cx", d => x(d.X))
                .attr("cy", d => y(d.Y))
                .attr("r", BASE_RADIUS)
                .attr("fill", "#7e212a")
                .attr("stroke", "#f8f1e9")
                .attr("stroke-width", 1);
            
            // Setup zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([1, 20])
                .on("zoom", (event) => {
                    currentTransform = event.transform;
                    updatePoints();
                });
                
            svg.call(zoom);
            
            // Function to calculate point size based on zoom level
            function calculateRadius(baseRadius) {
                // Dots grow with zoom level but max out at MAX_RADIUS
                const adjustedRadius = baseRadius * Math.sqrt(currentTransform.k);
                return Math.min(adjustedRadius, MAX_RADIUS);
            }
            
            // Function to update point positions based on zoom transform
            function updatePoints() {
                circles
                    .attr("cx", d => currentTransform.applyX(x(d.X)))
                    .attr("cy", d => currentTransform.applyY(y(d.Y)))
                    .attr("r", d => d.highlighted ? 
                        calculateRadius(HIGHLIGHT_BASE_RADIUS) : 
                        calculateRadius(BASE_RADIUS));
            }
            
            // Handle map clicks
            svg.on("click", function(event) {
                const [clickX, clickY] = d3.pointer(event);
                
                // Store the click point for zoom centering
                lastClickCoordinates = [clickX, clickY];
                
                // Convert screen coordinates back to data coordinates
                const invertedX = currentTransform.invertX(clickX);
                const invertedY = currentTransform.invertY(clickY);
                
                const clickCoord = {
                    X: x.invert(invertedX),
                    Y: y.invert(invertedY)
                };
                
                // Calculate distances
                const distances = data.map(d => ({
                    ...d,
                    distance: Math.sqrt(Math.pow(d.X - clickCoord.X, 2) + Math.pow(d.Y - clickCoord.Y, 2))
                }));
                
                // Get 10 closest points
                const closestPoints = distances
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 10);
                
                // Reset all points
                data.forEach(d => d.highlighted = false);
                
                // Mark closest points as highlighted
                closestPoints.forEach(point => {
                    const dataPoint = data.find(d => d.X === point.X && d.Y === point.Y);
                    if (dataPoint) dataPoint.highlighted = true;
                });
                
                // Update the display
                circles
                    .attr("fill", d => d.highlighted ? "#f1a7cd" : "#7e212a")
                    .attr("r", d => d.highlighted ? 
                        calculateRadius(HIGHLIGHT_BASE_RADIUS) : 
                        calculateRadius(BASE_RADIUS));
                
                // Update sidebar
                updateSidebar(closestPoints);
            });
            
            // Function to zoom centered on last click point
            function zoomCentered(scale) {
                if (!lastClickCoordinates) {
                    // If no point has been clicked yet, zoom from center
                    svg.transition().duration(300).call(zoom.scaleBy, scale);
                    return;
                }
                
                // Get current center point
                const [x, y] = lastClickCoordinates;
                
                // Calculate new transform
                const transform = d3.zoomIdentity
                    .translate(currentTransform.x, currentTransform.y)
                    .scale(currentTransform.k * scale)
                    .translate(
                        (width / 2 - x) / (currentTransform.k * scale),
                        (height / 2 - y) / (currentTransform.k * scale)
                    );
                
                // Apply the transform
                svg.transition().duration(300).call(zoom.transform, transform);
            }
            
            // Connect zoom buttons
            zoomInBtn.addEventListener("click", () => {
                zoomCentered(1.5);
            });
            
            zoomOutBtn.addEventListener("click", () => {
                zoomCentered(0.75);
            });
            
            resetBtn.addEventListener("click", () => {
                lastClickCoordinates = null; // Reset the click point
                svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
            });
        });
        
        // Function to update sidebar content
        function updateSidebar(stores) {
            const container = document.getElementById("closest-stores");
            container.innerHTML = "";
            
            stores.forEach((store, index) => {
                const storeElement = document.createElement("div");
                storeElement.className = "store-item";
                
                const nameElement = document.createElement("div");
                nameElement.className = "store-name";
                nameElement.textContent = `${index + 1}. ${store.Store_Name}`;
                
                const addressElement = document.createElement("div");
                addressElement.className = "store-address";
                addressElement.textContent = `${store.Store_Street_Address}, ${store.City}, ${store.State} ${store.Zip_Code}`;
                
                const typeElement = document.createElement("div");
                typeElement.className = "store-type";
                typeElement.textContent = `Type: ${store.Store_Type}`;
                
                storeElement.appendChild(nameElement);
                storeElement.appendChild(addressElement);
                storeElement.appendChild(typeElement);
                container.appendChild(storeElement);
            });
        }
    </script>
</body>